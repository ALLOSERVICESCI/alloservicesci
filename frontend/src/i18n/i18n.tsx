import React, { createContext, useContext, useMemo, useState, useEffect } from 'react';
import AsyncStorage from '@react-native-async-storage/async-storage';

type Dict = Record<string, string>;

type I18nCtx = {
  t: (k: string) => string;
  setLang: (l: Lang) => Promise&lt;void&gt;;
  lang: Lang;
  isRTL: boolean;
  ready: boolean;
};

export type Lang = 'fr' | 'en' | 'es' | 'it' | 'ar';

const STORAGE_KEY = 'app_lang_v1';

// Note: Keep keys consistent across languages. Add new keys here as needed.
const dicts: Record&lt;Lang, Dict&gt; = {
  fr: {
    brand: 'Allô Services CI',
    slogan: 'Tous les services essentiels en un clic',
    hello: 'Bonjour',
    tabHome: 'Accueil',
    tabAlerts: 'Alertes',
    tabPharm: 'Pharmacies',
    tabPremium: 'Premium',
    tabProfile: 'Profil',
    newAlert: 'Nouvelle alerte',
    notAvailable: 'N/A',
    requiredFields: 'Champs requis',
    requiredMsg: 'Veuillez remplir les champs obligatoires.',
    error: 'Erreur',
    fetchError: 'Impossible de charger les données',
    createAccount: 'Créer mon compte',
    submit: 'Créer mon compte',
    createTitle: 'Créer un compte',
    firstName: 'Prénom',
    lastName: 'Nom',
    emailOpt: 'Email (optionnel)',
    phonePh: 'Téléphone',
    welcomeShort: 'Bienvenue',
    legalConsentPrefix: 'En vous inscrivant, vous acceptez nos',
    legalAnd: 'et notre',
    legalCGU: 'CGU',
    legalPolicy: 'Politique de confidentialité',
    legalRequiredError: 'Vous devez accepter les CGU et la Politique de confidentialité pour continuer.',
    cat_urgence: 'Urgence',
    cat_sante: 'Santé',
    cat_education: 'Éducation',
    cat_services_publics: 'Services publics',
    cat_services_utiles: 'Services utiles',
    cat_agriculture: 'Agriculture',
    cat_loisirs: 'Loisirs &amp; Tourisme',
    cat_examens: 'Examens &amp; Concours',
    cat_transport: 'Transport',
    cat_alertes: 'Alertes',
    premiumLabel: 'Premium',
    premiumFeatures: 'Fonctionnalités Premium',
    premiumAnnualTitle: 'Premium 1200 FCFA / an',
    markAsRead: 'Marquer comme lu',
    loginRequired: 'Connexion requise',
    welcome: 'Bienvenue',
    profileReady: 'Bienvenue, votre profil est prêt',
    // Profile / common actions
    paymentReturnPrompt: 'Êtes-vous revenu du paiement ? ',
    refreshStatus: 'Actualiser le statut',
    network: 'Réseau',
    editProfile: 'Modifier mon profil',
    notifCenter: 'Centre de notifications',
    paymentHistory: 'Historique des paiements',
    premium: 'Premium',
    activeUntil: "actif jusqu'au",
    inactive: 'inactif',
    language: 'Langue',
    actions: 'Actions',
    premiumActive: 'Premium actif',
    becomePremium: 'Devenir Premium',
    premiumCallToAction: 'Accédez à toutes les fonctionnalités exclusives en devenant Premium.',
    expiresOn: 'Expire le',
    renewPremium: 'Renouveler Premium',
    subscribePremium: 'S’abonner à Premium',
    logout: 'Se déconnecter',
  },
  en: {
    brand: 'Allô Services CI',
    slogan: 'All key services in one tap',
    hello: 'Hello',
    tabHome: 'Home',
    tabAlerts: 'Alerts',
    tabPharm: 'Pharmacies',
    tabPremium: 'Premium',
    tabProfile: 'Profile',
    newAlert: 'New alert',
    notAvailable: 'N/A',
    requiredFields: 'Required fields',
    requiredMsg: 'Please fill the required fields.',
    error: 'Error',
    fetchError: 'Unable to load data',
    createAccount: 'Create my account',
    submit: 'Create my account',
    createTitle: 'Create an account',
    firstName: 'First name',
    lastName: 'Last name',
    emailOpt: 'Email (optional)',
    phonePh: 'Phone',
    welcomeShort: 'Welcome',
    legalConsentPrefix: 'By signing up, you accept our',
    legalAnd: 'and our',
    legalCGU: 'Terms',
    legalPolicy: 'Privacy Policy',
    legalRequiredError: 'You must accept the Terms and Privacy Policy to continue.',
    cat_urgence: 'Emergency',
    cat_sante: 'Health',
    cat_education: 'Education',
    cat_services_publics: 'Public Services',
    cat_services_utiles: 'Useful Services',
    cat_agriculture: 'Agriculture',
    cat_loisirs: 'Leisure &amp; Tourism',
    cat_examens: 'Exams &amp; Contests',
    cat_transport: 'Transport',
    cat_alertes: 'Alerts',
    premiumLabel: 'Premium',
    premiumFeatures: 'Premium features',
    premiumAnnualTitle: 'Premium 1200 XOF / year',
    markAsRead: 'Mark as read',
    loginRequired: 'Login required',
    welcome: 'Welcome',
    // Profile / common actions
    paymentReturnPrompt: 'Did you return from payment?',
    refreshStatus: 'Refresh status',
    network: 'Network',
    editProfile: 'Edit profile',
    notifCenter: 'Notifications Center',
    paymentHistory: 'Payment history',
    premium: 'Premium',
    activeUntil: 'active until',
    inactive: 'inactive',
    language: 'Language',
    actions: 'Actions',
    premiumActive: 'Premium active',
    becomePremium: 'Become Premium',
    premiumCallToAction: 'Unlock all exclusive features by becoming Premium.',
    expiresOn: 'Expires on',
    renewPremium: 'Renew Premium',
    subscribePremium: 'Subscribe to Premium',
    logout: 'Log out',
  },
  es: {
    brand: 'Allô Services CI',
    slogan: 'Todos los servicios esenciales en un clic',
    hello: 'Hola',
    tabHome: 'Inicio',
    tabAlerts: 'Alertas',
    tabPharm: 'Farmacias',
    tabPremium: 'Premium',
    tabProfile: 'Perfil',
    newAlert: 'Nueva alerte',
    notAvailable: 'N/D',
    requiredFields: 'Campos requeridos',
    requiredMsg: 'Complete los campos obligatorios.',
    error: 'Error',
    fetchError: 'No se pueden cargar los datos',
    createAccount: 'Crear mi cuenta',
    submit: 'Crear mi cuenta',
    createTitle: 'Crear una cuenta',
    firstName: 'Nombre',
    lastName: 'Apellido',
    emailOpt: 'Email (opcional)',
    phonePh: 'Teléfono',
    welcomeShort: 'Bienvenido',
    legalConsentPrefix: 'Al registrarte, aceptas nuestras',
    legalAnd: 'y nuestra',
    legalCGU: 'Condiciones',
    legalPolicy: 'Política de privacidad',
    legalRequiredError: 'Debes aceptar las Condiciones y la Política de privacidad para continuar.',
    cat_urgence: 'Urgencia',
    cat_sante: 'Salud',
    cat_education: 'Educación',
    cat_services_publics: 'Servicios públicos',
    cat_services_utiles: 'Servicios útiles',
    cat_agriculture: 'Agricultura',
    cat_loisirs: 'Ocio y Turismo',
    cat_examens: 'Exámenes y Concursos',
    cat_transport: 'Transporte',
    cat_alertes: 'Alertas',
    premiumLabel: 'Premium',
    premiumFeatures: 'Funciones Premium',
    premiumAnnualTitle: 'Premium 1200 FCFA / año',
    markAsRead: 'Marcar como leído',
    loginRequired: 'Se requiere inicio de sesión',
    welcome: 'Bienvenido',
    // Profile / common actions
    paymentReturnPrompt: '¿Has vuelto del pago?',
    refreshStatus: 'Actualizar estado',
    network: 'Red',
    editProfile: 'Editar perfil',
    notifCenter: 'Centro de notificaciones',
    paymentHistory: 'Historial de pagos',
    premium: 'Premium',
    activeUntil: 'activo hasta',
    inactive: 'inactivo',
    language: 'Idioma',
    actions: 'Acciones',
    premiumActive: 'Premium activo',
    becomePremium: 'Hazte Premium',
    premiumCallToAction: 'Accede a todas las funciones exclusivas haciéndote Premium.',
    expiresOn: 'Expira el',
    renewPremium: 'Renovar Premium',
    subscribePremium: 'Suscribirse a Premium',
    logout: 'Cerrar sesión',
  },
  it: {
    brand: 'Allô Services CI',
    slogan: 'Tutti i servizi essenziali in un clic',
    hello: 'Ciao',
    tabHome: 'Home',
    tabAlerts: 'Allerte',
    tabPharm: 'Farmacie',
    tabPremium: 'Premium',
    tabProfile: 'Profilo',
    newAlert: 'Nuova allerta',
    notAvailable: 'N/D',
    requiredFields: 'Campi obbligatori',
    requiredMsg: 'Compila i campi obbligatori.',
    error: 'Errore',
    fetchError: 'Impossibile caricare i dati',
    createAccount: 'Crea il mio account',
    submit: 'Crea il mio account',
    createTitle: 'Crea un account',
    firstName: 'Nome',
    lastName: 'Cognome',
    emailOpt: 'Email (opzionale)',
    phonePh: 'Telefono',
    welcomeShort: 'Benvenuto',
    legalConsentPrefix: 'Registrandoti accetti i nostri',
    legalAnd: 'e la nostra',
    legalCGU: 'Termini',
    legalPolicy: 'Informativa sulla privacy',
    legalRequiredError: "Devi accettare i Termini e l'Informativa sulla privacy per continuare.",
    cat_urgence: 'Emergenza',
    cat_sante: 'Salute',
    cat_education: 'Educazione',
    cat_services_publics: 'Servizi pubblici',
    cat_services_utiles: 'Servizi utili',
    cat_agriculture: 'Agricoltura',
    cat_loisirs: 'Tempo libero e Turismo',
    cat_examens: 'Esami e Concorsi',
    cat_transport: 'Trasporti',
    cat_alertes: 'Allerte',
    premiumLabel: 'Premium',
    premiumFeatures: 'Funzionalità Premium',
    premiumAnnualTitle: 'Premium 1200 FCFA / anno',
    markAsRead: 'Segna come letto',
    loginRequired: 'Accesso richiesto',
    welcome: 'Benvenuto',
    // Profile / common actions
    paymentReturnPrompt: 'Sei tornato dal pagamento?',
    refreshStatus: 'Aggiorna stato',
    network: 'Rete',
    editProfile: 'Modifica profilo',
    notifCenter: 'Centro notifiche',
    paymentHistory: 'Storico pagamenti',
    premium: 'Premium',
    activeUntil: 'attivo fino al',
    inactive: 'inattivo',
    language: 'Lingua',
    actions: 'Azioni',
    premiumActive: 'Premium attivo',
    becomePremium: 'Diventa Premium',
    premiumCallToAction: 'Sblocca tutte le funzionalità esclusive diventando Premium.',
    expiresOn: 'Scade il',
    renewPremium: 'Rinnova Premium',
    subscribePremium: 'Abbonati a Premium',
    logout: 'Esci',
  },
  ar: {
    brand: 'خدمة آلو كوت ديفوار',
    slogan: 'كل الخدمات الأساسية بنقرة واحدة',
    hello: 'مرحبا',
    tabHome: 'الرئيسية',
    tabAlerts: 'التنبيهات',
    tabPharm: 'الصيدليات',
    tabPremium: 'بريميوم',
    tabProfile: 'الملف الشخصي',
    newAlert: 'تنبيه جديد',
    notAvailable: 'غير متاح',
    requiredFields: 'حقول مطلوبة',
    requiredMsg: 'يرجى ملء الحقول المطلوبة.',
    error: 'خطأ',
    fetchError: 'تعذر تحميل البيانات',
    createAccount: 'إنشاء حسابي',
    submit: 'إنشاء حسابي',
    createTitle: 'إنشاء حساب',
    firstName: 'الاسم الأول',
    lastName: 'الاسم الأخير',
    emailOpt: 'البريد الإلكتروني (اختياري)',
    phonePh: 'الهاتف',
    welcomeShort: 'أهلا بك',
    legalConsentPrefix: 'بالتسجيل، أنت توافق على',
    legalAnd: 'و',
    legalCGU: 'الشروط',
    legalPolicy: 'سياسة الخصوصية',
    legalRequiredError: 'يجب عليك قبول الشروط وسياسة الخصوصية للمتابعة.',
    cat_urgence: 'الطوارئ',
    cat_sante: 'الصحة',
    cat_education: 'التعليم',
    cat_services_publics: 'الخدمات العامة',
    cat_services_utiles: 'الخدمات المفيدة',
    cat_agriculture: 'الزراعة',
    cat_loisirs: 'الترفيه والسياحة',
    cat_examens: 'الامتحانات والمسابقات',
    cat_transport: 'النقل',
    cat_alertes: 'التنبيهات',
    premiumLabel: 'بريميوم',
    premiumFeatures: 'ميزات بريميوم',
    premiumAnnualTitle: 'بريميوم 1200 فرنك إفريقي / سنة',
    markAsRead: 'وضع علامة كمقروء',
    loginRequired: 'مطلوب تسجيل الدخول',
    welcome: 'أهلا بك',
    // Profile / common actions
    paymentReturnPrompt: 'هل عدت من عملية الدفع؟',
    refreshStatus: 'تحديث الحالة',
    network: 'الشبكة',
    editProfile: 'تعديل الملف الشخصي',
    notifCenter: 'مركز الإشعارات',
    paymentHistory: 'سجل الدفعات',
    premium: 'بريميوم',
    activeUntil: 'نشط حتى',
    inactive: 'غير نشط',
    language: 'اللغة',
    actions: 'الإجراءات',
    premiumActive: 'بريميوم مفعل',
    becomePremium: 'اشترك في بريميوم',
    premiumCallToAction: 'استمتع بجميع الميزات الحصرية بالاشتراك في بريميوم.',
    expiresOn: 'ينتهي في',
    renewPremium: 'تجديد بريميوم',
    subscribePremium: 'الاشتراك في بريميوم',
    logout: 'تسجيل الخروج',
  },
};

const I18nContext = createContext&lt;I18nCtx&gt;({ t: (k) =&gt; k, setLang: async () =&gt; {}, lang: 'fr', isRTL: false, ready: false });

export const I18nProvider: React.FC&lt;{ children: React.ReactNode }&gt; = ({ children }) =&gt; {
  const [lang, _setLang] = useState&lt;Lang&gt;('fr');
  const [ready, setReady] = useState(false);

  useEffect(() =&gt; {
    (async () =&gt; {
      try {
        const saved = await AsyncStorage.getItem(STORAGE_KEY);
        if (saved) {
          _setLang(saved as Lang);
        } else {
          _setLang('fr');
          await AsyncStorage.setItem(STORAGE_KEY, 'fr');
        }
      } catch {}
      setReady(true);
    })();
  }, []);

  const setLang = async (l: Lang) =&gt; {
    _setLang(l);
    try { await AsyncStorage.setItem(STORAGE_KEY, l); } catch {}
  };

  const dict = dicts[lang];
  const isRTL = lang === 'ar';
  const t = (k: string) =&gt; dict[k] || k;

  const value = useMemo(() =&gt; ({ t, setLang, lang, isRTL, ready }), [t, lang, isRTL, ready]);
  return &lt;I18nContext.Provider value={value}&gt;{children}&lt;/I18nContext.Provider&gt;;
};

export const useI18n = () =&gt; useContext(I18nContext);